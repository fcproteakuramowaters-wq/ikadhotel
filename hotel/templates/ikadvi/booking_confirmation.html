{% extends 'ikadbw/base_bw.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/booking-form.css' %}">
<div class="booking-confirmation-wrapper">
    <div class="booking-progress">
        <div class="progress-step completed">
            <span class="step-number">1</span>
            <span class="step-text">Select Dates</span>
        </div>
        <div class="progress-step completed">
            <span class="step-number">2</span>
            <span class="step-text">Choose Room</span>
        </div>
        <div class="progress-step current">
            <span class="step-number">3</span>
            <span class="step-text">Confirm & Pay</span>
        </div>
    </div>

    <div class="booking-summary">
        <h2>Booking Summary</h2>
        <div class="summary-details">
            <div class="summary-row">
                <div class="summary-icon">
                    <i class="bi bi-calendar-check"></i>
                </div>
                <div class="summary-info">
                    <div class="info-label">Check-in</div>
                    <div class="info-value" id="check-in-date"></div>
                </div>
            </div>
            <div class="summary-row">
                <div class="summary-icon">
                    <i class="bi bi-calendar-x"></i>
                </div>
                <div class="summary-info">
                    <div class="info-label">Check-out</div>
                    <div class="info-value" id="check-out-date"></div>
                </div>
            </div>
            <div class="summary-row">
                <div class="summary-icon">
                    <i class="bi bi-people"></i>
                </div>
                <div class="summary-info">
                    <div class="info-label">Guests</div>
                    <div class="info-value"><span id="adult-count">2</span> Adults</div>
                </div>
            </div>
            <div class="summary-row">
                <div class="summary-icon">
                    <i class="bi bi-house"></i>
                </div>
                <div class="summary-info">
                    <div class="info-label">Room Type</div>
                    <div class="info-value" id="room-type"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="booking-form">
        <h2>Guest Information</h2>
        <form id="confirmationForm" method="post" action="{% url 'confirm_booking' %}" onsubmit="return submitForm(event)">
            {% csrf_token %}
            <div class="form-section personal-info">
                <div class="form-row">
                    <div class="form-group">
                        <label for="firstName">First Name *</label>
                        <input type="text" id="firstName" name="firstName" required>
                    </div>
                    <div class="form-group">
                        <label for="lastName">Last Name *</label>
                        <input type="text" id="lastName" name="lastName" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="email">Email Address *</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">Phone Number *</label>
                        <input type="tel" id="phone" name="phone" required>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>Address Information</h3>
                <div class="form-group">
                    <label for="address">Street Address</label>
                    <input type="text" id="address" name="address">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="city">City</label>
                        <input type="text" id="city" name="city">
                    </div>
                    <div class="form-group">
                        <label for="state">State/Province</label>
                        <input type="text" id="state" name="state">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="country">Country</label>
                        <select id="country" name="country">
                            <option value="">Select Country</option>
                            <option value="NG">Nigeria</option>
                            <!-- Add more countries as needed -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="zipCode">Zip/Postal Code</label>
                        <input type="text" id="zipCode" name="zipCode">
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>Special Requests</h3>
                <div class="form-group">
                    <textarea id="specialRequests" name="specialRequests" rows="4" placeholder="Any special requests or requirements?"></textarea>
                </div>
            </div>

            <div class="price-summary">
                <h3>Price Details</h3>
                <div class="price-row">
                    <span>Room Rate (per night)</span>
                    <span class="price" id="room-rate">₦50,000</span>
                </div>
                <div class="price-row">
                    <span>Number of Nights</span>
                    <span id="num-nights">4</span>
                </div>
                <div class="price-row total">
                    <span>Total Amount</span>
                    <span class="price" id="total-amount">₦200,000</span>
                </div>
            </div>

            <!-- Hidden fields for booking details -->
            <input type="hidden" id="roomRateInput" name="roomRate" value="">
            <input type="hidden" id="numNightsInput" name="numNights" value="">
            <input type="hidden" id="totalAmountInput" name="totalAmount" value="">
            <!-- Hidden fields to preserve booking context for redirect -->
            <input type="hidden" id="roomTypeInput" name="room_type" value="{{ room_type }}">
            <input type="hidden" id="checkinInput" name="checkin" value="{{ checkin }}">
            <input type="hidden" id="checkoutInput" name="checkout" value="{{ checkout }}">
            <input type="hidden" id="guestsInput" name="guests" value="{{ guests }}">
            
            <div class="form-section terms">
                <div class="form-group checkbox">
                    <input type="checkbox" id="terms" name="terms" required>
                    <label for="terms">I agree to the terms and conditions *</label>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn secondary" onclick="history.back()">Back</button>
                <button type="submit" class="btn primary">Confirm Booking</button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Format dates
    const checkin = new Date(parseInt('{{ checkin }}') * 1000);
    const checkout = new Date(parseInt('{{ checkout }}') * 1000);
    
    document.getElementById('check-in-date').textContent = checkin.toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
    
    document.getElementById('check-out-date').textContent = checkout.toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });

    // Set room type based on selection
    document.getElementById('room-type').textContent = '{{ room_type }}';

    // Initialize phone input with country codes
    const phoneInput = document.getElementById('phone');
    window.intlTelInput(phoneInput, {
        preferredCountries: ['ng'],
        utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"
    });

    // Set hidden field values
    const roomRate = document.getElementById('room-rate').textContent.replace('₦', '').replace(/,/g, '').trim();
    const numNights = document.getElementById('num-nights').textContent.trim();
    const totalAmount = document.getElementById('total-amount').textContent.replace('₦', '').replace(/,/g, '').trim();

    document.getElementById('roomRateInput').value = roomRate;
    document.getElementById('numNightsInput').value = numNights;
    document.getElementById('totalAmountInput').value = totalAmount;
});

function submitForm(event) {
    event.preventDefault();
    const form = document.getElementById('confirmationForm');
    const formData = new FormData(form);

    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (response.redirected) {
            window.location.href = response.url;
            return;
        }

        // Fallback: decide where to send the user based on room_type
        const formRoomType = formData.get('room_type') || '';
        const lowerRoom = formRoomType.toLowerCase();
        const fallBackUrl = (lowerRoom.includes('studio') || lowerRoom.includes('elite') || lowerRoom.includes('premier') || lowerRoom.includes('luxury') || lowerRoom.includes('master')) ? '/hotels/victoria-island/' : '/hotels/cooli-hotel/';
        window.location.href = fallBackUrl;
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while processing your booking. Please try again.');
    });

    return false;
}
</script>
{% endblock %}